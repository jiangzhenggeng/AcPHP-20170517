<?php 
// +--------------------------------------------------------------------------------------
// + AcPHP
// +--------------------------------------------------------------------------------------
// + 版权所有 2015年11月9日 贵州天岛在线科技有限公司，并保留所有权利。
// + 网站地址: http://www.acphp.com
// +--------------------------------------------------------------------------------------
// + 这不是一个自由软件！您只能在遵守授权协议前提下对程序代码进行修改和使用；不允许对程序代码以任何形式任何目的的再发布。
// + 授权协议：http://www.acphp.com/license.html
// +--------------------------------------------------------------------------------------
// + Author: AcPHP  http://www.jiangzg.com/ <2992265870@qq.com/jiangzg>
// + Release Date: 2015年11月9日 上午12:43:33
// +--------------------------------------------------------------------------------------
defined('C_CA') or exit('Server error does not pass validation test.');

class xSession {
	// +--------------------------------------------------------------------------------------
	// + 设置session
	// +--------------------------------------------------------------------------------------
	public static function set($name,$value){
		return self::session($name,'set',$value);
	}
	
	// +--------------------------------------------------------------------------------------
	// + 获取session
	// +--------------------------------------------------------------------------------------
	public static function get($name='',$default=''){
		return self::session($name,'get',$default);
	}
	
	// +--------------------------------------------------------------------------------------
	// + 删除session
	// +--------------------------------------------------------------------------------------
	public static function delete($name){
		return self::session($name,'delete');
	}
	// +--------------------------------------------------------------------------------------
	// + 删除session
	// +--------------------------------------------------------------------------------------
	public static function _unset($name){
		return self::session($name,'delete');
	}
	// +--------------------------------------------------------------------------------------
	// + 销毁session
	// +--------------------------------------------------------------------------------------
	public static function destroy(){
		return self::session(NULL,'destroy');
	}
	// +--------------------------------------------------------------------------------------
	// + 清空session
	// +--------------------------------------------------------------------------------------
	public static function clear(){
		return self::session(NULL,'clear');
	}
	
	// +--------------------------------------------------------------------------------------
	// + 启动session
	// +--------------------------------------------------------------------------------------
	public static function start(){
		return self::session(NULL,'start');
	}
	
	// +--------------------------------------------------------------------------------------
	// + 暂停session
	// +--------------------------------------------------------------------------------------
	public static function pause(){
		return self::session(NULL,'pause');
	}
	
	// +--------------------------------------------------------------------------------------
	// + 重新生成sessionid
	// +--------------------------------------------------------------------------------------
	public static function regenerate(){
		return self::session(NULL,'regenerate');
	}
	
	// +--------------------------------------------------------------------------------------
	// + session操作
	// +--------------------------------------------------------------------------------------
	public static function session($name,$type='get',$value=''){
		$prefix = trim(App::getConfig('Session','session_prefix'));
	
		if(strtolower($type)==='destroy'){
			// +------------------------------------------------------------------------------
			// + 销毁session
			// +------------------------------------------------------------------------------
			$_SESSION =  array();
			session_unset();
			session_destroy();
			return true;
		}elseif(strtolower($type)==='clear'){
			// +------------------------------------------------------------------------------
			// + 清空session
			// +------------------------------------------------------------------------------
			if($prefix){
				unset($_SESSION[$prefix]);
			}else{
				unset($_SESSION);
			}
			return true;
		}elseif (strtolower($type)==='pause'){
			// +------------------------------------------------------------------------------
			// + 暂停session
			// +------------------------------------------------------------------------------
			session_write_close();
			return true;
		}elseif(strtolower($type)==='start'){
			if (!isset($_SESSION)){
				// +------------------------------------------------------------------------------
				// + 配置session
				// +------------------------------------------------------------------------------
				self::_config();
				// +------------------------------------------------------------------------------
				// + 启动session
				// +------------------------------------------------------------------------------
				session_start();
			}
			return true;
		}elseif('regenerate'==$name){
			// +------------------------------------------------------------------------------
			// + 重新生成id
			// +------------------------------------------------------------------------------
			session_regenerate_id();
			return true;
		}
	
		$name = trim($name);
		$name = str_replace(array('.','/'), '|', $name);
		$name = explode('|', $name);
		// +----------------------------------------------------------------------------------
		// + Seeeion临时存储变量
		// +----------------------------------------------------------------------------------
		$_SESSION_TEMP = array();
		// +----------------------------------------------------------------------------------
		// + 设置Session变量前缀
		// +----------------------------------------------------------------------------------
		if($prefix){
			$_SESSION_TEMP = '$_SESSION["'.$prefix.'"]';
		}else{
			$_SESSION_TEMP = '$_SESSION';
		}
	
		// +----------------------------------------------------------------------------------
		// + 迭代SESSION的路径
		// +----------------------------------------------------------------------------------
		foreach ($name as $k => $v ){
			if(trim($v)!='')$_SESSION_TEMP = $_SESSION_TEMP.'["'.$v.'"]';
		}
		// +----------------------------------------------------------------------------------
		// + session相关操作
		// +----------------------------------------------------------------------------------
		if(strtolower($type)==='get'){
			// +------------------------------------------------------------------------------
			// + 获取session
			// +------------------------------------------------------------------------------
			eval('$tempValue = isset('.$_SESSION_TEMP.')?'.$_SESSION_TEMP.':$value;');
			return $tempValue;
		}elseif(strtolower($type)==='set'){
			// +------------------------------------------------------------------------------
			// + 设置session
			// +------------------------------------------------------------------------------
			eval($_SESSION_TEMP.'=$value;');
			return true;
		}elseif(strtolower($type)==='delete'){
			// +------------------------------------------------------------------------------
			// + 删除session
			// +------------------------------------------------------------------------------
			eval('unset('.$_SESSION_TEMP.');');
			return true;
		}
		return true;
	}
	
	// +--------------------------------------------------------------------------------------
	// + 配置session驱动
	// +--------------------------------------------------------------------------------------
	private static function _config(){
		// 读取session驱动
		$type = trim(App::getConfig('Session','session_type'));
		if($type!=='') {
			if(strtolower($type)==='file')return true;
			//载入session驱动接口
			App::loadClass('SessionAbstract',C_SYS_LIBRARY_PATH.'Session'.C_DIR_FIX,FALSE);
			//载入session驱动类并实例化
			$class = 'Session'.ucwords($type);
			App::loadClass($class,C_SYS_LIBRARY_PATH.'Session'.C_DIR_FIX.'Drive'.C_DIR_FIX);
			$hander = $class::getInstance();
			session_set_save_handler(
					array(&$hander,"open"),
					array(&$hander,"close"),
					array(&$hander,"read"),
					array(&$hander,"write"),
					array(&$hander,"destroy"),
					array(&$hander,"gc")
			);
		}
		return true;
	}
}